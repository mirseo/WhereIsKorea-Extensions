const KOREA_KEYWORDS=new Set([ '대한민국','한국','남한','코리아','서울','daehanminguk','south korea','korea','republic of korea','rok','kr','kor','korea,republic of','korea(south)','korea,south','s. korea','so. korea','south korean','k-country','k.r','rep. of korea','south of korea','korea(s)','the land of the morning calm','410','+82','韓国','韩国','corée du sud','südkorea','corea del sur','coreia do sul','zuid-korea','южная корея','كوريا الجنوبية','republik korea','république de corée','república de corea','repubblica di corea','corea','coreia','大韓民國','大韩民国','大韓民国','đại hàn dân quốc','kr-','kr-kr' ].map(k=>k.toLowerCase()));const KOREA_PATTERNS=[/\b(South\s*Korea|Korea\s*Republic|Republic\s*of\s*Korea)\b/i,/\b(대한민국|한국)\b/,/\bKR\b/i,/\bKOR\b/i,/\+82\b/];let autoSelectEnabled=false;let processedElements=new WeakSet();let mutationObserver=null;chrome.storage.local.get(['koreaSelectorEnabled'],function(result){autoSelectEnabled=result.koreaSelectorEnabled !==false;if(autoSelectEnabled){initAutoSelector();}});chrome.runtime.onMessage.addListener(function(request,sender,sendResponse){if(request.action==='toggleAutoSelect'){autoSelectEnabled=request.enabled;if(autoSelectEnabled){initAutoSelector();sendResponse({success:true,message:'자동 선택이 활성화되었습니다'});}else{if(mutationObserver){mutationObserver.disconnect();mutationObserver=null;}processedElements=new WeakSet();sendResponse({success:true,message:'자동 선택이 비활성화되었습니다'});}}return true;});function initAutoSelector(){if(!autoSelectEnabled)return;if(mutationObserver)mutationObserver.disconnect();processAllPotentialSelectors();mutationObserver=new MutationObserver((mutations)=>{if(!autoSelectEnabled)return;for(const mutation of mutations){for(const node of mutation.addedNodes){if(node.nodeType===Node.ELEMENT_NODE){findAndProcessSelectors(node);}}}});mutationObserver.observe(document.body,{childList:true,subtree:true});}function processAllPotentialSelectors(){console.log('[KoreaSEL] Initial processing of all potential selectors.');findAndProcessSelectors(document.body);}function findAndProcessSelectors(rootElement){const selects=rootElement.querySelectorAll('select');selects.forEach(processSelect);const customDropdowns=rootElement.querySelectorAll('[role="combobox"],[aria-haspopup="listbox"],.country-select');customDropdowns.forEach(processCustomDropdown);}function isLikelyCountrySelector(element){const attributes=[ element.id,element.name,element.className,element.getAttribute('placeholder'),element.getAttribute('aria-label')].join(' ').toLowerCase();let labelText='';if(element.id){const label=document.querySelector(`label[for="${element.id}"]`);if(label){labelText=label.textContent.toLowerCase();}}const fullText=attributes+' '+labelText;const countryIndicators=['country','nation','nationality','location','region','국가','나라','지역'];if(countryIndicators.some(indicator=>fullText.includes(indicator))){return true;}if(element.tagName==='SELECT' && element.options.length>10){const sampleOptions=Array.from(element.options).slice(1,10).map(o=>o.textContent.toLowerCase()).join(' ');const sampleCountries=['united states','japan','china','canada'];if(sampleCountries.some(country=>sampleOptions.includes(country))){return true;}}return false;}function isKoreaMatch(text){const normalizedText=text.toLowerCase().trim();if(KOREA_KEYWORDS.has(normalizedText)){return true;}for(const keyword of KOREA_KEYWORDS){if(normalizedText.includes(keyword))return true;}for(const pattern of KOREA_PATTERNS){if(pattern.test(text)){return true;}}return false;}function processSelect(selectElement){if(!autoSelectEnabled || processedElements.has(selectElement))return;if(isLikelyCountrySelector(selectElement)){console.groupCollapsed(`[KoreaSEL] Processing<select>:${selectElement.id || selectElement.name || 'No ID/Name'}`);processedElements.add(selectElement);const koreaOption=Array.from(selectElement.options).find(option=>isKoreaMatch(option.textContent)|| isKoreaMatch(option.value));if(koreaOption && !koreaOption.selected){console.log('Found Korea option:',koreaOption.textContent);selectKoreaOption(selectElement,koreaOption);}else{console.log('Korea option not found or already selected.');}console.groupEnd();}}function selectKoreaOption(selectElement,koreaOption){try{selectElement.value=koreaOption.value;koreaOption.selected=true;['change','input','blur'].forEach(eventType=>{selectElement.dispatchEvent(new Event(eventType,{bubbles:true}));});updateStats();console.log('Successfully selected:',koreaOption.textContent);}catch(error){console.error('Error selecting Korea option in<select>:',error);}}function processCustomDropdown(triggerElement){if(!autoSelectEnabled || processedElements.has(triggerElement))return;if(triggerElement.getAttribute('aria-expanded')==='true')return;if(triggerElement.tagName==='SELECT')return;if(isLikelyCountrySelector(triggerElement)){console.groupCollapsed(`[KoreaSEL] Processing Custom Dropdown Trigger:`,triggerElement);processedElements.add(triggerElement);triggerElement.click();setTimeout(()=>{const listboxes=document.querySelectorAll('[role="listbox"]');let found=false;listboxes.forEach(box=>{const options=box.querySelectorAll('[role="option"],li,a,div');const koreaOptionElement=Array.from(options).find(opt=>isKoreaMatch(opt.textContent));if(koreaOptionElement){console.log('Found Korea option in custom dropdown:',koreaOptionElement.textContent);koreaOptionElement.click();updateStats();found=true;}});if(!found){console.log('Korea option not found in opened custom dropdown.');triggerElement.click();}},500);console.groupEnd();}}function updateStats(){chrome.storage.local.get(['koreaSelectorStats'],function(result){const stats=result.koreaSelectorStats ||{totalSelections:0};stats.totalSelections++;stats.lastSelection={url:window.location.href,timestamp:Date.now()};chrome.storage.local.set({koreaSelectorStats:stats});});}